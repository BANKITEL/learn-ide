#!/usr/bin/env ruby

STDOUT.sync = true

require 'pty'
require 'json'
require 'base64'
require 'fileutils'
#require 'net/http'
#require 'uri'

#username = ENV['QUERY_STRING'].split('=').last
#stdout, stdin, _pid = PTY.spawn("TERM=xterm-256color sudo su - #{username}")

#Thread.new do
  #loop do
    #line = stdout.readpartial(4096)
    #puts Base64.encode64(line)
  #end
#end

Thread.new do
  loop do
    fs_event_data = JSON.parse(STDIN.readline)
    project_path = fs_event_data['project']['path']
    file_path    = fs_event_data['file']['path']
    full_path    = "/Users/loganhasson/Desktop/code_dir/#{(file_path.split('/') - project_path.split('/')).join('/')}"

    case fs_event_data['action']
    when 'local_save'
      needed_dirs = full_path.split('/')[0..-2].join('/')
      FileUtils.mkdir_p(needed_dirs)

      File.open(full_path, 'w+') do |f|
        f.write(Base64.decode64(fs_event_data['buffer']['content']))
      end
    when 'local_delete'
      FileUtils.rm_rf(full_path)
    else
      # Nothing
    end
    File.open('/Users/loganhasson/Desktop/fs_save.log', 'a') do |f|
      f.write fs_event_data
    end
  end
end

while true
end
